<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HoopsLink - Find Your Game</title>
  <!-- Include Supabase JS Library (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* --- Global Styles & Variables --- */
    :root {
      --primary-color: #ff6b00;
      --secondary-color: #4a00e0;
      --accent-color: #00f2a9;
      --background-color: #121212;
      --surface-color: #1e1e1e;
      --text-color: #e0e0e0;
      --text-color-dark: #111111;
      --success-color: #00d18b;
      --error-color: #ff4d4d;
      --font-family: 'Poppins', sans-serif;
      --border-radius: 12px;
      --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      --transition-speed: 0.3s;
      --transition-effect: ease-in-out;
    }

    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      height: 100%;
    }

    body {
      min-height: 100%;
      font-family: var(--font-family);
      background-color: #000000;
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      font-size: 16px;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    input, textarea {
      user-select: auto;
      -webkit-user-select: auto;
      -moz-user-select: text;
      -ms-user-select: auto;
    }

    #app-container {
      width: 100%;
      max-width: 900px;
      min-height: 600px;
      height: auto;
      max-height: 95vh;
      background: linear-gradient(135deg, #1a1a1a 0%, #111 100%);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      margin: auto;
    }

    /* --- Screen Management --- */
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--background-color);
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-speed) var(--transition-effect), transform var(--transition-speed) var(--transition-effect);
      transform: translateX(100%);
      display: flex;
      flex-direction: column;
      z-index: 1;
    }

    .screen.active {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
      z-index: 10;
    }

    /* Specific screen transitions */
    #auth-screen.active { transform: translateX(0); }
    #loading-screen.active { transform: scale(1); opacity: 1; z-index: 100; }
    #main-app-screen.active { transform: translateX(0); }
    #game-detail-screen.active { transform: translateX(0); }
    #active-game-screen.active { transform: scale(1); opacity: 1; }
    #game-end-screen.active { transform: translateY(0); opacity: 1; }
    #profile-screen.active { transform: translateX(0); }
    #leaderboard-screen.active { transform: translateX(0); }

    #loading-screen {
      transform: scale(1.1);
      transition: opacity var(--transition-speed) ease-out, transform var(--transition-speed) ease-out;
      background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    #loading-screen h1.logo {
      font-size: 3rem;
      font-weight: 900;
      color: #FFFFFF;
      background: none;
      -webkit-background-clip: unset;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
    }

    /* ... More CSS styles omitted for brevity ... */
  </style>
</head>
<body>
  <div id="app-container">
    <!-- Loading Screen -->
    <div id="loading-screen" class="screen active">
      <h1 class="logo">HoopsLink</h1>
      <div class="loader mt-1"></div>
      <p class="mt-1">Finding your court...</p>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="screen flex-col">
      <div id="auth-form-container">
        <h2 id="auth-title">Login to HoopsLink</h2>
        <form id="auth-form">
          <div class="mb-1">
            <label for="email">Email</label>
            <input type="email" id="email" required>
          </div>
          <div class="mb-1">
            <label for="password">Password</label>
            <input type="password" id="password" required>
          </div>
          <div id="username-field" class="mb-1 hidden">
            <label for="username">Username</label>
            <input type="text" id="username" minlength="3">
            <small style="font-size: 0.8em; color: #aaa;">Min 3 characters, used for display.</small>
          </div>
          <div id="auth-error" class="error-text mb-1"></div>
          <button type="submit" id="auth-submit-btn" class="btn-primary w-full">Login</button>
        </form>
        <div class="auth-toggle">
          <span id="auth-toggle-text">Don't have an account?</span>
          <button id="auth-toggle-btn">Sign Up</button>
        </div>
      </div>
    </div>

    <!-- Main App Screen (Game List) -->
    <div id="main-app-screen" class="screen flex-col">
      <header class="app-header">
        <div class="logo">HoopsLink</div>
        <div class="header-actions">
          <button id="leaderboard-nav-btn" title="Leaderboard">
            <!-- SVG icon omitted for brevity -->
          </button>
          <button id="profile-nav-btn" title="Profile">
            <!-- SVG icon omitted for brevity -->
          </button>
          <button id="logout-btn" title="Logout">
            <!-- SVG icon omitted for brevity -->
          </button>
        </div>
      </header>
      <div class="content-area">
        <h2 class="text-center p-1">Upcoming Games</h2>
        <div id="game-list-loader" class="loader hidden"></div>
        <ul id="game-list"></ul>
        <p id="no-games-message" class="text-center mt-2 hidden">No games found. Why not create one?</p>
      </div>
      <button id="create-game-fab" title="Create Game">+</button>
    </div>

    <!-- Game Detail, Active Game, Game End, Profile, Leaderboard, Chat Drawer, Create Game Modal, and Share Modal sections omitted for brevity -->
  </div> <!-- End #app-container -->

  <script>
    // --- SUPABASE CLIENT SETUP ---
    const SUPABASE_URL = 'https://aghnqhwhpiwndronbgkd.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';
    let supabase = null;

    if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
      if (SUPABASE_URL && SUPABASE_ANON_KEY && SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
        try {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log("Supabase client initialized successfully.");
        } catch (error) {
          console.error("Error initializing Supabase client:", error);
          alert("DB connection error.");
          supabase = null;
        }
      } else {
        console.error("Supabase URL/Key not configured.");
        alert("App config error.");
      }
    } else {
      console.error("Supabase library failed to load!");
      alert("Critical Error: DB library missing.");
    }

    // --- APPLICATION STATE ---
    let currentUser = null;
    let userProfile = null;
    let currentScreen = 'loading';
    let currentGameId = null;
    let currentGameData = null;
    let gameSubscription = null;
    let gamesSubscription = null;
    let scoreProposals = {};
    let currentScoreProposal = null;
    let confirmingScore = false;
    let leaderboardScope = 'global';
    let leaderboardFilterValue = null;

    // --- UI ELEMENTS CACHE ---
    // (Element references are defined here. Omitted for brevity.)

    // --- UTILITY FUNCTIONS ---
    const debounce = (func, delay) => {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => { func.apply(this, args); }, delay);
      };
    };

    const formatDate = (dateString) => {
      if (!dateString) return 'Date TBD';
      try {
        const date = new Date(dateString);
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(now.getDate() + 1);
        const optionsTime = { hour: 'numeric', minute: 'numeric', hour12: true };
        const optionsDate = { month: 'short', day: 'numeric' };
        if (date.toDateString() === now.toDateString())
          return `Today, ${date.toLocaleTimeString('en-US', optionsTime)}`;
        else if (date.toDateString() === tomorrow.toDateString())
          return `Tomorrow, ${date.toLocaleTimeString('en-US', optionsTime)}`;
        else
          return `${date.toLocaleDateString('en-US', optionsDate)}, ${date.toLocaleTimeString('en-US', optionsTime)}`;
      } catch (e) {
        console.error("Date format error:", e);
        return "Invalid Date";
      }
    };

    const showElement = (el) => el?.classList.remove('hidden');
    const hideElement = (el) => el?.classList.add('hidden');
    const enableElement = (el) => { if(el) el.disabled = false; };
    const disableElement = (el) => { if(el) el.disabled = true; };

    const navigateTo = (screenName) => {
      // Navigation logic (omitted for brevity)
    };

    const getUserAvatarText = (username) => username ? username.charAt(0).toUpperCase() : '?';

    const getUserProfile = async (userId) => {
      if (!supabase || !userId) return null;
      try {
        console.log("Fetching profile:", userId);
        const { data, error } = await supabase.from('profiles').select('*').eq('user_id', userId).single();
        if (error && error.code !== 'PGRST116') {
          console.error('Fetch profile error:', error);
          return null;
        }
        console.log("Profile fetched:", data);
        return data;
      } catch (error) {
        console.error('Fetch profile exception:', error);
        return null;
      }
    };

    const updateUserProfile = async (userId, updates) => {
      // Update profile logic (omitted for brevity)
    };

    const createInitialUserProfile = async (userId, email, username) => {
      // Create profile logic (omitted for brevity)
    };

    // --- MISSING FUNCTION DEFINITION ---
    function handleCreateGameSubmit(e) {
      e.preventDefault();
      const loc = document.getElementById('game-location').value;
      const dt = document.getElementById('game-datetime').value;
      const btn = e.target.querySelector('button[type="submit"]');
      createGameError.textContent = '';
      disableElement(btn);
      // Assuming createGame is defined elsewhere and returns a promise.
      createGame(loc, dt).then(({ data, error }) => {
        enableElement(btn);
        if (error)
          createGameError.textContent = error.message;
        else {
          console.log("Game created:", data);
          toggleCreateGameModal(false);
        }
      });
    }

    // --- AUTHENTICATION LOGIC & onAuthStateChange ---
    let isCheckingSession = false;
    const checkUserSession = async () => {
      if (isCheckingSession) return;
      isCheckingSession = true;
      try {
        console.log("Checking session...");
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) {
          console.error("Get session error:", error);
          navigateTo('auth');
        } else if (session?.user) {
          currentUser = session.user;
          console.log("Session found:", currentUser.id);
          if (!userProfile || userProfile.user_id !== currentUser.id)
            userProfile = await getUserProfile(currentUser.id);
          if (!userProfile) {
            console.warn("Profile missing:", currentUser.id);
            alert("Profile data missing.");
            if (currentScreen === 'auth' || currentScreen === 'loading') {
              navigateTo('main');
              fetchGames();
            }
          } else {
            console.log("Profile loaded:", userProfile.username);
            if (currentScreen === 'auth' || currentScreen === 'loading') {
              navigateTo('main');
              fetchGames();
            }
          }
        } else {
          console.log("No active session.");
          if (currentScreen !== 'auth') navigateTo('auth');
        }
      } catch (err) {
        console.error("Session check error:", err);
        if (currentScreen !== 'auth') navigateTo('auth');
      } finally {
        hideElement(screens.loading);
        isCheckingSession = false;
      }
    };

    const handleAuth = async (event) => {
      // Authentication logic (omitted for brevity)
    };

    const handleLogout = async () => {
      // Logout logic (omitted for brevity)
    };

    const toggleAuthMode = () => {
      // Toggle auth mode logic (omitted for brevity)
    };

    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('Auth Event:', event, session ? 'Session User:' : 'No Session', session?.user?.id);
      if (event === 'SIGNED_OUT') {
        handleLogout();
      } else if (event === 'SIGNED_IN' || event === 'USER_UPDATED') {
        currentUser = session?.user ?? null;
        await checkUserSession();
      }
    });

    // --- EVENT HANDLERS & INITIALIZATION ---
    function initApp() {
      console.log("Initializing HoopsLink App...");
      if (!supabase) {
        console.error("Supabase client needed.");
        hideElement(screens.loading);
        authError.textContent = "Config error.";
        authTitle.textContent = "Error";
        disableElement(authSubmitBtn);
        disableElement(authToggleBtn);
        navigateTo('auth');
        return;
      }

      authForm.addEventListener('submit', handleAuth);
      authToggleBtn.addEventListener('click', toggleAuthMode);
      logoutBtn.addEventListener('click', handleLogout);
      createGameFab.addEventListener('click', () => toggleCreateGameModal(true));
      createGameForm.addEventListener('submit', handleCreateGameSubmit);
      // (Other event listeners omitted for brevity)
      checkUserSession();
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
