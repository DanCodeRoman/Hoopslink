<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HoopsLink - Find Your Game</title>
  <!-- Include Supabase JS Library (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* --- Global Styles & Variables --- */
    :root {
      --primary-color: #ff6b00; /* Energetic Orange */
      --secondary-color: #4a00e0; /* Vibrant Purple */
      --accent-color: #00f2a9; /* Electric Teal */
      --background-color: #121212; /* Dark Container Background */
      --surface-color: #1e1e1e; /* Slightly Lighter Surface */
      --text-color: #e0e0e0; /* Light Text */
      --text-color-dark: #111111; /* Dark Text for light backgrounds */
      --success-color: #00d18b;
      --error-color: #ff4d4d;
      --font-family: 'Poppins', sans-serif; /* Playful but clean font */
      --border-radius: 12px;
      --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      --transition-speed: 0.3s;
      --transition-effect: ease-in-out;
    }

    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      height: 100%;
    }

    body {
      min-height: 100%;
      font-family: var(--font-family);
      background-color: #000000;
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      font-size: 16px;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    input, textarea {
      user-select: auto;
      -webkit-user-select: auto;
      -moz-user-select: text;
      -ms-user-select: auto;
    }

    #app-container {
      width: 100%;
      max-width: 900px;
      min-height: 600px;
      height: auto;
      max-height: 95vh;
      background: linear-gradient(135deg, #1a1a1a 0%, #111 100%);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      margin: auto;
    }

    /* --- Screen Management --- */
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--background-color);
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-speed) var(--transition-effect), transform var(--transition-speed) var(--transition-effect);
      transform: translateX(100%);
      display: flex;
      flex-direction: column;
      z-index: 1;
    }

    .screen.active {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
      z-index: 10;
    }

    /* Specific screen transitions */
    #auth-screen.active { transform: translateX(0); }
    #loading-screen.active { transform: scale(1); opacity: 1; z-index: 100; }
    #main-app-screen.active { transform: translateX(0); }
    #game-detail-screen.active { transform: translateX(0); }
    #active-game-screen.active { transform: scale(1); opacity: 1; }
    #game-end-screen.active { transform: translateY(0); opacity: 1; }
    #profile-screen.active { transform: translateX(0); }
    #leaderboard-screen.active { transform: translateX(0); }

    #loading-screen {
      transform: scale(1.1);
      transition: opacity var(--transition-speed) ease-out, transform var(--transition-speed) ease-out;
      background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    /* Loading screen logo */
    #loading-screen h1.logo {
      font-size: 3rem;
      font-weight: 900;
      color: #FFFFFF;
      background: none;
      -webkit-background-clip: unset;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
    }

    #game-end-screen {
      transform: translateY(100%);
    }

    /* --- Utility Classes --- */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .bold { font-weight: bold; }
    .primary-text { color: var(--primary-color); }
    .secondary-text { color: var(--secondary-color); }
    .accent-text { color: var(--accent-color); }
    .error-text { color: var(--error-color); font-size: 0.9em; margin-top: 5px; }
    .success-text { color: var(--success-color); }
    .flex-col { display: flex; flex-direction: column; }
    .flex-row { display: flex; flex-direction: row; }
    .flex-center { display: flex; justify-content: center; align-items: center; }
    .flex-grow { flex-grow: 1; }
    .space-between { justify-content: space-between; }
    .align-center { align-items: center; }
    .p-1 { padding: 1rem; }
    .p-2 { padding: 2rem; }
    .m-1 { margin: 1rem; }
    .mt-1 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 1rem; }
    .ml-1 { margin-left: 1rem; }
    .mr-1 { margin-right: 1rem; }
    .gap-1 { gap: 1rem; }
    .gap-05 { gap: 0.5rem; }
    .w-full { width: 100%; }

    /* --- Basic Elements Styling --- */
    button, input[type="submit"] {
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: transform var(--transition-speed) var(--transition-effect), background-color var(--transition-speed) var(--transition-effect), box-shadow var(--transition-speed) var(--transition-effect);
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    button::before, input[type="submit"]::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.5s ease-out, height 0.5s ease-out;
      z-index: -1;
    }

    button:active::before, input[type="submit"]:active::before {
      width: 300px;
      height: 300px;
    }

    button:hover, input[type="submit"]:hover {
      transform: translateY(-3px) scale(1.03);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    button:active, input[type="submit"]:active {
      transform: translateY(0) scale(1);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
      background: linear-gradient(45deg, var(--primary-color), #ffa040);
      color: var(--text-color-dark);
    }

    .btn-secondary {
      background: linear-gradient(45deg, var(--secondary-color), #8a2be2);
      color: var(--text-color);
    }
    .btn-accent {
      background: linear-gradient(45deg, var(--accent-color), #00c896);
      color: var(--text-color-dark);
    }

    .btn-danger {
      background: linear-gradient(45deg, var(--error-color), #ff6f6f);
      color: var(--text-color);
    }

    .btn-outline {
      background-color: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }
    .btn-outline:hover {
      background-color: var(--primary-color);
      color: var(--text-color-dark);
    }

    /* Style for active filter button */
    .filter-btn.active {
      background-color: var(--primary-color);
      color: var(--text-color-dark);
      font-weight: bold;
    }

    input[type="text"], input[type="email"], input[type="password"], input[type="datetime-local"], textarea {
      width: 100%;
      padding: 12px 15px;
      background-color: var(--surface-color);
      border: 1px solid transparent;
      border-radius: var(--border-radius);
      color: var(--text-color);
      font-size: 1rem;
      transition: border-color var(--transition-speed) var(--transition-effect), box-shadow var(--transition-speed);
    }

    input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, input[type="datetime-local"]:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.3);
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--accent-color);
    }

    h1, h2, h3 {
      font-weight: 700;
      margin-bottom: 1rem;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }
    h1 {
      font-size: 2.5rem;
      line-height: 1.1;
      color: #FFFFFF;
      font-weight: 900;
      background: none;
      -webkit-background-clip: unset;
    }
    h2 { font-size: 1.8rem; color: var(--primary-color); }
    h3 { font-size: 1.4rem; color: var(--secondary-color); }

    hr {
      border: none;
      height: 1px;
      background-color: var(--surface-color);
      margin: 1rem 0;
    }

    /* --- Header / Navbar --- */
    .app-header {
      padding: 1rem;
      background-color: var(--surface-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      z-index: 50;
      position: sticky;
      top: 0;
      border-top-left-radius: var(--border-radius);
      border-top-right-radius: var(--border-radius);
    }

    .app-header .logo {
      font-size: 1.5rem;
      font-weight: 900;
      color: #FFFFFF;
      background: none;
      -webkit-background-clip: unset;
      cursor: pointer;
    }

    .header-actions button {
      background: none;
      border: none;
      color: var(--accent-color);
      font-size: 1.5rem;
      cursor: pointer;
      margin-left: 1rem;
      padding: 5px;
      transition: color var(--transition-speed), transform var(--transition-speed);
    }
    .header-actions button:hover {
      color: var(--primary-color);
      transform: scale(1.1);
    }

    /* --- Content Area --- */
    .screen > .content-area {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) var(--surface-color);
    }
    .screen > .content-area::-webkit-scrollbar {
      width: 8px;
    }
    .screen > .content-area::-webkit-scrollbar-track {
      background: var(--surface-color);
      border-radius: 10px;
    }
    .screen > .content-area::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 10px;
      border: 2px solid var(--surface-color);
    }

    /* --- Loading Spinner --- */
    .loader {
      border: 6px solid var(--surface-color);
      border-top: 6px solid var(--primary-color);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* --- Specific Screen Styles --- */
    /* Auth Screen */
    #auth-screen {
      background: linear-gradient(180deg, var(--secondary-color) 0%, var(--background-color) 70%);
      justify-content: center;
      align-items: center;
      padding: 2rem;
      height: 100%;
    }
    #auth-form-container {
      background-color: rgba(30, 30, 30, 0.8);
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 100%;
      max-width: 380px;
      backdrop-filter: blur(5px);
      margin: auto;
    }
    #auth-form-container h2 {
      color: var(--accent-color);
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .auth-toggle {
      margin-top: 1rem;
      text-align: center;
    }
    .auth-toggle button {
      background: none;
      border: none;
      color: var(--primary-color);
      text-decoration: underline;
      font-size: 0.9rem;
      cursor: pointer;
    }

    /* Main App Screen (Game List) */
    #main-app-screen > .content-area { padding: 0; }
    #game-list {
      list-style: none;
      padding: 1rem 0;
    }
    .game-list-item {
      background-color: var(--surface-color);
      margin: 1rem;
      padding: 1rem 1.5rem;
      border-radius: var(--border-radius);
      border-left: 5px solid var(--primary-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: transform var(--transition-speed), box-shadow var(--transition-speed), border-color var(--transition-speed);
      animation: slideInUp 0.5s var(--transition-effect) backwards;
      opacity: 0;
      animation-delay: calc(var(--animation-order, 0) * 0.05s);
    }

    @keyframes slideInUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .game-list-item:hover {
      transform: translateX(5px) scale(1.02);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      border-left-color: var(--accent-color);
    }
    .game-info h3 { margin-bottom: 0.3rem; color: var(--text-color); font-size: 1.2rem; }
    .game-meta { font-size: 0.9rem; color: #aaa; }
    .game-status-indicator {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
      text-transform: uppercase;
    }
    .status-pending { background-color: var(--primary-color); color: var(--text-color-dark); }
    .status-active { background-color: var(--success-color); color: var(--text-color-dark); }
    .status-finished { background-color: var(--secondary-color); color: var(--text-color); }

    #create-game-fab {
      position: absolute;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
      color: var(--text-color-dark);
      font-size: 2rem;
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      z-index: 20;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #create-game-fab:hover {
      transform: scale(1.1) rotate(90deg);
    }

    /* Create Game Modal */
    #create-game-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease;
      backdrop-filter: blur(5px);
    }
    #create-game-modal.visible {
      opacity: 1;
      visibility: visible;
    }
    #create-game-form-container {
      background-color: var(--surface-color);
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 90%;
      max-width: 450px;
      transform: scale(0.9);
      transition: transform var(--transition-speed) cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #create-game-modal.visible #create-game-form-container {
      transform: scale(1);
    }

    /* Game Detail / Lobby Screen */
    #game-detail-screen > .content-area,
    #active-game-screen > .content-area {
      padding: 1.5rem;
    }
    #game-detail-header h2 {
      color: var(--primary-color);
      background: none;
      -webkit-background-clip: unset;
      margin-bottom: 0.5rem;
    }
    #game-detail-meta span { margin-right: 1rem; color: #ccc; font-size: 0.9rem; }
    #player-list { list-style: none; padding: 0; }
    .player-list-item {
      background-color: var(--surface-color);
      padding: 10px 15px;
      border-radius: var(--border-radius);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: fadeIn 0.5s ease forwards;
      opacity: 0;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .player-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--secondary-color);
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: var(--text-color);
    }
    .player-username { font-weight: 600; }
    .player-status { margin-left: auto; font-size: 0.8rem; color: #aaa; }
    #game-actions { max-width: 300px; margin: 1rem auto 0 auto; }
    #game-actions button { width: 100%; margin-top: 10px; }

    /* Active Game Screen */
    #active-game-screen {
      background: linear-gradient(180deg, #222 0%, var(--background-color) 80%);
    }
    .scoreboard {
      display: flex;
      justify-content: space-around;
      align-items: center;
      background-color: rgba(0,0,0,0.3);
      padding: 1rem;
      border-radius: var(--border-radius);
      margin-bottom: 1.5rem;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    .team-score { text-align: center; }
    .team-name { font-size: 1rem; font-weight: 600; margin-bottom: 5px; color: #aaa; }
    .score {
      font-size: 3rem;
      font-weight: 900;
      line-height: 1;
      transition: transform 0.3s ease, color 0.3s ease;
      cursor: pointer;
    }
    .score:hover { transform: scale(1.1); }
    #team-a-score { color: var(--primary-color); }
    #team-b-score { color: var(--accent-color); }
    .vs { font-size: 1.5rem; font-weight: bold; color: var(--text-color); }

    .team-display { display: flex; gap: 1rem; margin-top: 1rem; max-width: 700px; margin-left: auto; margin-right: auto; }
    .team-column {
      flex: 1;
      background-color: var(--surface-color);
      padding: 1rem;
      border-radius: var(--border-radius);
    }
    .team-column h4 { margin-bottom: 1rem; text-align: center; }
    #team-a-list h4 { color: var(--primary-color); }
    #team-b-list h4 { color: var(--accent-color); }
    .team-player {
      font-size: 0.9rem;
      padding: 5px 0;
      border-bottom: 1px solid #333;
    }
    .team-player:last-child { border-bottom: none; }

    #score-confirmation-modal {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--surface-color);
      padding: 1rem 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      z-index: 1001;
      display: flex;
      align-items: center;
      gap: 1rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
      transform: translate(-50%, 20px);
    }
    #score-confirmation-modal.visible {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%);
    }
    #score-confirmation-modal button {
      padding: 8px 15px;
      font-size: 0.9rem;
    }

    /* Game End Screen */
    #game-end-screen {
      background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 2rem;
      position: relative;
      overflow: hidden;
    }
    #game-end-summary {
      background-color: rgba(30, 30, 30, 0.8);
      padding: 2.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(5px);
      animation: zoomIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      opacity: 0;
      max-width: 500px;
      width: 90%;
    }
    @keyframes zoomIn {
      from { transform: scale(0.5); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    #game-end-summary h2 { color: var(--accent-color); font-size: 2.5rem; }
    #final-score { font-size: 1.8rem; margin-bottom: 1.5rem; }
    #mvp-highlight {
      background-color: rgba(0,0,0,0.3);
      padding: 1rem;
      border-radius: var(--border-radius);
      margin-bottom: 1.5rem;
      border: 2px solid var(--accent-color);
    }
    #mvp-highlight h3 { color: var(--accent-color); margin-bottom: 0.5rem; font-size: 1.2rem; }
    #mvp-username { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); }
    #mvp-score { font-size: 1rem; color: #ccc; }
    #game-end-actions button { margin: 0.5rem; }

    /* Confetti */
    .confetti {
      position: absolute;
      width: 10px;
      height: 20px;
      background-color: var(--primary-color);
      opacity: 0.7;
      animation: confetti-fall 4s linear infinite;
      pointer-events: none;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotateZ(0deg); opacity: 0.7; }
      100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; }
    }
    #confetti-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 0;
    }

    /* Profile Screen */
    #profile-screen > .content-area { padding: 2rem; }
    #profile-header { text-align: center; margin-bottom: 1rem; }
    #profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      margin: 0 auto 1rem auto;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 4rem;
      font-weight: bold;
      color: var(--text-color);
      box-shadow: 0 0 20px rgba(255, 107, 0, 0.5);
    }
    #profile-username-display { display: inline-block; margin-bottom: 0.5rem; }
    #profile-username { font-size: 1.8rem; font-weight: bold; }
    #edit-profile-btn, #save-profile-btn {
      background: none;
      border: none;
      color: var(--accent-color);
      cursor: pointer;
      font-size: 0.9rem;
      margin-left: 10px;
      vertical-align: middle;
      padding: 5px;
    }
    #save-profile-btn { font-weight: bold; }

    #profile-edit-fields {
      max-width: 350px;
      margin: 0 auto 1.5rem auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    #profile-email { font-size: 0.9em; color: #aaa; margin-bottom: 1rem; }

    #profile-stats {
      background-color: var(--surface-color);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      margin-top: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .stat-item { text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); }
    .stat-label { font-size: 0.9rem; color: #aaa; }

    #game-history-list { margin-top: 1.5rem; list-style: none; padding: 0; max-width: 700px; margin-left: auto; margin-right: auto; }
    .history-item { background-color: var(--surface-color); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem; border-left: 4px solid var(--secondary-color); }
    .history-details { font-size: 0.9em; color: #ccc; margin-bottom: 5px; }
    .history-score { font-weight: bold; }
    .history-result { font-weight: bold; }
    .result-win { color: var(--success-color); }
    .result-loss { color: var(--error-color); }

    /* Leaderboard Screen */
    #leaderboard-screen > .content-area { padding: 0; display: flex; flex-direction: column; }
    #leaderboard-filters {
      padding: 0.5rem 1rem;
      background-color: var(--surface-color);
      text-align: center;
      border-bottom: 1px solid var(--background-color);
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    #leaderboard-filters button {
      padding: 8px 15px;
      font-size: 0.9rem;
      background-color: transparent;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    #leaderboard-filters button:hover {
      background-color: rgba(255, 107, 0, 0.2);
      transform: none;
      box-shadow: none;
    }
    #leaderboard-filters button.active {
      background-color: var(--primary-color);
      color: var(--text-color-dark);
      font-weight: bold;
      border-color: var(--primary-color);
    }
    #leaderboard-status {
      text-align: center;
      padding: 0.5rem;
      font-size: 0.9em;
      color: var(--accent-color);
    }

    #leaderboard-list-container {
      flex-grow: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) var(--surface-color);
    }
    #leaderboard-list-container::-webkit-scrollbar { width: 8px; }
    #leaderboard-list-container::-webkit-scrollbar-track {
      background: var(--surface-color);
      border-radius: 10px;
    }
    #leaderboard-list-container::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 10px;
      border: 2px solid var(--surface-color);
    }

    #leaderboard-list { list-style: none; padding: 1rem 0; max-width: 700px; margin: 0 auto; }
    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      margin: 0 1rem 1rem 1rem;
      background-color: var(--surface-color);
      border-radius: var(--border-radius);
      position: relative;
      transition: transform 0.2s ease-in-out;
      animation: fadeIn 0.5s ease forwards;
      opacity: 0;
      animation-delay: calc(var(--animation-order, 0) * 0.05s);
    }
    .leaderboard-item:hover { transform: scale(1.03); }
    .leaderboard-rank {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary-color);
      width: 40px;
      text-align: center;
      margin-right: 1rem;
    }
    .leaderboard-item:nth-child(1) .leaderboard-rank {
      color: #ffd700;
      font-size: 1.6rem;
    }
    .leaderboard-item:nth-child(2) .leaderboard-rank {
      color: #c0c0c0;
      font-size: 1.4rem;
    }
    .leaderboard-item:nth-child(3) .leaderboard-rank {
      color: #cd7f32;
      font-size: 1.3rem;
    }
    .leaderboard-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background-color: var(--secondary-color);
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: var(--text-color);
      margin-right: 1rem;
    }
    .leaderboard-info { flex-grow: 1; }
    .leaderboard-username { font-weight: 600; }
    .leaderboard-stat { font-size: 0.9rem; color: #aaa; }
    .leaderboard-score { font-size: 1.1rem; font-weight: bold; color: var(--accent-color); }

    /* Chat */
    #chat-drawer {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 350px;
      height: 60%;
      max-height: 450px;
      background-color: var(--surface-color);
      border-top-left-radius: var(--border-radius);
      border-bottom-left-radius: var(--border-radius);
      box-shadow: -10px 0 30px rgba(0,0,0,0.5);
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
      z-index: 900;
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }
    #chat-drawer.open { transform: translateX(0); }
    #chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #444;
    }
    #chat-header h3 { margin-bottom: 0; color: var(--accent-color); }
    #close-chat-btn {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.5rem;
      cursor: pointer;
    }
    #chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      margin-bottom: 1rem;
      scrollbar-width: thin;
      scrollbar-color: var(--secondary-color) var(--background-color);
    }
    #chat-messages::-webkit-scrollbar { width: 6px; }
    #chat-messages::-webkit-scrollbar-track {
      background: var(--background-color);
      border-radius: 10px;
    }
    #chat-messages::-webkit-scrollbar-thumb {
      background-color: var(--secondary-color);
      border-radius: 10px;
    }
    .chat-message {
      margin-bottom: 0.8rem;
      display: flex;
      flex-direction: column;
      max-width: 90%;
      animation: popIn 0.3s ease forwards;
      opacity: 0;
    }
    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .chat-message.own { align-self: flex-end; align-items: flex-end; }
    .message-bubble {
      padding: 8px 12px;
      border-radius: var(--border-radius);
      background-color: #333;
      color: var(--text-color);
      word-wrap: break-word;
    }
    .chat-message.own .message-bubble {
      background: linear-gradient(45deg, var(--primary-color), #ffa040);
      color: var(--text-color-dark);
    }
    .message-meta {
      font-size: 0.75rem;
      color: #aaa;
      margin-top: 3px;
    }
    .chat-message.own .message-meta { text-align: right; }
    .message-sender {
      font-weight: bold;
      margin-right: 5px;
    }
    #chat-input-area {
      display: flex;
      gap: 10px;
    }
    #chat-input {
      flex-grow: 1;
      background-color: #444;
      border: none;
    }
    #chat-input:focus {
      box-shadow: none;
      border: 1px solid var(--secondary-color);
    }

    /* Modal Base */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease;
      backdrop-filter: blur(5px);
    }
    .modal.visible { opacity: 1; visibility: visible; }
    .modal-content {
      background-color: var(--surface-color);
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 90%;
      max-width: 450px;
      transform: scale(0.9);
      transition: transform var(--transition-speed) cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
    }
    .modal.visible .modal-content { transform: scale(1); }
    .modal-close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.8rem;
      cursor: pointer;
      line-height: 1;
      padding: 5px;
    }

    /* Share Modal */
    #share-options button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      text-align: left;
      padding: 12px 15px;
      background-color: #444;
      color: var(--text-color);
    }
    #share-options button:hover {
      background-color: #555;
      transform: none;
      box-shadow: none;
    }
    #share-link-input { margin-top: 1rem; }
  </style>
</head>
<body>
  <div id="app-container">
    <!-- Loading Screen -->
    <div id="loading-screen" class="screen active">
      <h1 class="logo">HoopsLink</h1>
      <div class="loader mt-1"></div>
      <p class="mt-1">Finding your court...</p>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="screen flex-col">
      <div id="auth-form-container">
        <h2 id="auth-title">Login to HoopsLink</h2>
        <form id="auth-form">
          <div class="mb-1">
            <label for="email">Email</label>
            <input type="email" id="email" required>
          </div>
          <div class="mb-1">
            <label for="password">Password</label>
            <input type="password" id="password" required>
          </div>
          <div id="username-field" class="mb-1 hidden">
            <label for="username">Username</label>
            <input type="text" id="username" minlength="3">
            <small style="font-size: 0.8em; color: #aaa;">Min 3 characters, used for display.</small>
          </div>
          <div id="auth-error" class="error-text mb-1"></div>
          <button type="submit" id="auth-submit-btn" class="btn-primary w-full">Login</button>
        </form>
        <div class="auth-toggle">
          <span id="auth-toggle-text">Don't have an account?</span>
          <button id="auth-toggle-btn">Sign Up</button>
        </div>
      </div>
    </div>

    <!-- Main App Screen (Game List) -->
    <div id="main-app-screen" class="screen flex-col">
      <header class="app-header">
        <div class="logo">HoopsLink</div>
        <div class="header-actions">
          <button id="leaderboard-nav-btn" title="Leaderboard">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
              <path d="M120-120v-150h150v150H120Zm0-270v-150h150v150H120Zm0-270v-150h150v150H120Zm270 270v-150h150v150H390Zm0-270v-150h150v150H390Zm270 540v-150h150v150H660Zm0-270v-150h150v150H660Zm0-270v-150h150v150H660Zm-270 0v-150h150v150H390Z"/>
            </svg>
          </button>
          <button id="profile-nav-btn" title="Profile">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
              <path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Z"/>
            </svg>
          </button>
          <button id="logout-btn" title="Logout">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
              <path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v120H200v560h280v120H200Zm440-160-55-58 102-102H360v-120h327L585-662l55-58 200 200-200 200Z"/>
            </svg>
          </button>
        </div>
      </header>
      <div class="content-area">
        <h2 class="text-center p-1">Upcoming Games</h2>
        <div id="game-list-loader" class="loader hidden"></div>
        <ul id="game-list"></ul>
        <p id="no-games-message" class="text-center mt-2 hidden">No games found. Why not create one?</p>
      </div>
      <button id="create-game-fab" title="Create Game">+</button>
    </div>

    <!-- Game Detail / Lobby Screen -->
    <div id="game-detail-screen" class="screen flex-col">
      <header class="app-header">
        <button class="back-btn" style="background:none; border:none; font-size: 1.5rem; color: var(--accent-color); cursor:pointer;">&lt;</button>
        <div class="logo">Game Lobby</div>
        <div></div>
      </header>
      <div class="content-area">
        <div id="game-detail-loader" class="loader"></div>
        <div id="game-detail-content" class="hidden">
          <div id="game-detail-header">
            <h2 id="game-detail-location">Location Name</h2>
            <div id="game-detail-meta" class="mb-1">
              <span id="game-detail-datetime">📅 Time</span>
              <span id="game-detail-creator">👑 Created by User</span>
            </div>
            <div id="game-detail-status" class="mb-1 bold">Status: <span class="status-indicator">Pending</span></div>
          </div>
          <hr>
          <h3>Players (<span id="player-count">0</span>/<span id="max-players">10</span>)</h3>
          <ul id="player-list" class="mb-1"></ul>
          <div id="game-actions">
            <button id="join-leave-game-btn" class="btn-primary w-full">Join Game</button>
            <button id="begin-game-btn" class="btn-secondary hidden w-full">Begin Game (Creator Only)</button>
            <button id="cancel-game-btn" class="btn-danger hidden w-full">Cancel Game (Creator Only)</button>
            <button id="share-game-btn" class="btn-accent mt-1 w-full">Share Game</button>
          </div>
          <div id="game-detail-error" class="error-text mt-1 text-center"></div>
          <hr>
          <button id="toggle-chat-btn" class="btn-outline w-full mt-1" style="max-width: 200px; margin-left: auto; margin-right:auto;">Show Chat</button>
        </div>
      </div>
    </div>

    <!-- Active Game Screen -->
    <div id="active-game-screen" class="screen flex-col">
      <header class="app-header">
        <div class="logo" style="font-size: 1.2rem;">Active Game</div>
        <button id="active-game-toggle-chat-btn" class="btn-outline" style="padding: 5px 10px; font-size: 0.9rem;">Chat</button>
      </header>
      <div class="content-area">
        <div id="active-game-loader" class="loader"></div>
        <div id="active-game-content" class="hidden">
          <div class="scoreboard">
            <div class="team-score">
              <div class="team-name">Team A</div>
              <div id="team-a-score" class="score" data-team="A">0</div>
            </div>
            <div class="vs">VS</div>
            <div class="team-score">
              <div class="team-name">Team B</div>
              <div id="team-b-score" class="score" data-team="B">0</div>
            </div>
          </div>
          <p id="score-proposal-message" class="text-center mb-1 success-text hidden"></p>
          <p id="score-error-message" class="text-center mb-1 error-text hidden"></p>
          <div class="team-display">
            <div id="team-a-list" class="team-column">
              <h4>Team A</h4>
            </div>
            <div id="team-b-list" class="team-column">
              <h4>Team B</h4>
            </div>
          </div>
          <p class="text-center mt-2" style="font-size: 0.9em; color: #aaa;">Click score to propose +1 point.</p>
        </div>
      </div>
      <div id="score-confirmation-modal" class="">
        <p id="score-confirm-text">Confirm +1 for Team X?</p>
        <button id="confirm-score-btn" class="btn-success">Confirm</button>
        <button id="reject-score-btn" class="btn-danger">Reject</button>
      </div>
    </div>

    <!-- Game End Screen -->
    <div id="game-end-screen" class="screen flex-col">
      <div id="confetti-container"></div>
      <div id="game-end-summary">
        <h2 id="game-end-title">Game Over!</h2>
        <p id="final-score" class="bold">Team A: 10 - Team B: 8</p>
        <div id="mvp-highlight" class="hidden">
          <h3>🏆 Top Scorer (MVP) 🏆</h3>
          <p id="mvp-username" class="bold">MVP_User</p>
          <p id="mvp-score">Scored X points</p>
        </div>
        <div id="game-end-actions" class="flex-col gap-05">
          <button id="back-to-main-btn" class="btn-primary">Back to Games</button>
          <button id="view-leaderboard-btn" class="btn-secondary">View Leaderboard</button>
          <button id="share-results-btn" class="btn-accent">Share Results</button>
        </div>
      </div>
    </div>

    <!-- Profile Screen -->
    <div id="profile-screen" class="screen flex-col">
      <header class="app-header">
        <button class="back-btn" style="background:none; border:none; font-size: 1.5rem; color: var(--accent-color); cursor:pointer;">&lt;</button>
        <div class="logo">Your Profile</div>
        <div></div>
      </header>
      <div class="content-area">
        <div id="profile-loader" class="loader"></div>
        <div id="profile-content" class="hidden">
          <div id="profile-header">
            <div id="profile-avatar">U</div>
            <div id="profile-username-display">
              <span id="profile-username" class="bold">Username</span>
              <button id="edit-profile-btn">✏️</button>
            </div>
            <div id="profile-edit-fields" class="hidden">
              <div class="mb-1">
                <label for="edit-profile-username-input">Username</label>
                <input type="text" id="edit-profile-username-input" placeholder="New username" minlength="3">
              </div>
              <div class="mb-1">
                <label for="edit-profile-city">City</label>
                <input type="text" id="edit-profile-city" placeholder="Your City">
              </div>
              <div class="mb-1">
                <label for="edit-profile-state">State / Province</label>
                <input type="text" id="edit-profile-state" placeholder="Your State/Province">
              </div>
              <div class="mb-1">
                <label for="edit-profile-country">Country</label>
                <input type="text" id="edit-profile-country" placeholder="Your Country">
              </div>
              <button id="save-profile-btn" class="btn-primary mt-1">💾 Save Changes</button>
            </div>
            <div id="profile-email" style="font-size: 0.9em; color: #aaa;">user@example.com</div>
          </div>
          <div id="profile-update-message" class="success-text text-center mt-1"></div>
          <div id="profile-update-error" class="error-text text-center mt-1"></div>
          <div id="profile-stats">
            <div class="stat-item">
              <div id="profile-stat-points" class="stat-value">0</div>
              <div class="stat-label">Total Points</div>
            </div>
            <div class="stat-item">
              <div id="profile-stat-games" class="stat-value">0</div>
              <div class="stat-label">Games Played</div>
            </div>
            <div class="stat-item">
              <div id="profile-stat-mvp" class="stat-value">0</div>
              <div class="stat-label">MVP Awards</div>
            </div>
          </div>
          <hr style="max-width: 700px; margin-left: auto; margin-right: auto;">
          <h3 class="text-center">Game History</h3>
          <div id="game-history-loader" class="loader hidden"></div>
          <ul id="game-history-list"></ul>
          <p id="no-history-message" class="text-center mt-1 hidden">No completed games yet.</p>
        </div>
      </div>
    </div>

    <!-- Leaderboard Screen -->
    <div id="leaderboard-screen" class="screen flex-col">
      <header class="app-header">
        <button class="back-btn" style="background:none; border:none; font-size: 1.5rem; color: var(--accent-color); cursor:pointer;">&lt;</button>
        <div class="logo">Leaderboard</div>
        <div class="header-actions">
          <button id="leaderboard-chat-toggle" title="Chat (Global/Local?)" class="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
              <path d="M800-80v-640q0-33-23.5-56.5T720-799H240q-33 0-56.5 23.5T160-720v480q0 33 23.5 56.5T240-160h400l160 160v-80Zm-80-80H240v-480h480v480Zm-40-140H280v-80h360v80Zm0-120H280v-80h360v80Z"/>
            </svg>
          </button>
        </div>
      </header>
      <div id="leaderboard-filters">
        <button class="filter-btn active" data-scope="global">Global</button>
        <button class="filter-btn" data-scope="country">My Country</button>
        <button class="filter-btn" data-scope="state">My State</button>
        <button class="filter-btn" data-scope="city">My City</button>
      </div>
      <div id="leaderboard-status" class="p-1 text-center accent-text">Showing Global Leaders</div>
      <div id="leaderboard-list-container">
        <div id="leaderboard-loader" class="loader"></div>
        <ul id="leaderboard-list"></ul>
        <p id="no-leaderboard-message" class="text-center mt-2 hidden">Leaderboard is empty for this filter.</p>
      </div>
    </div>

    <!-- Chat Drawer -->
    <div id="chat-drawer">
      <div id="chat-header">
        <h3 id="chat-title">Game Chat</h3>
        <button id="close-chat-btn">&times;</button>
      </div>
      <div id="chat-messages"></div>
      <div id="chat-input-area">
        <input type="text" id="chat-input" placeholder="Type your message...">
        <button id="send-chat-btn" class="btn-secondary">Send</button>
      </div>
    </div>

    <!-- Create Game Modal -->
    <div id="create-game-modal" class="modal">
      <div id="create-game-form-container" class="modal-content">
        <button class="modal-close-btn" onclick="toggleCreateGameModal(false)">&times;</button>
        <h2>Create New Game</h2>
        <form id="create-game-form">
          <div class="mb-1">
            <label for="game-location">Location Name</label>
            <input type="text" id="game-location" required>
          </div>
          <div class="mb-1">
            <label for="game-datetime">Date & Time</label>
            <input type="datetime-local" id="game-datetime" required>
          </div>
          <div id="create-game-error" class="error-text mb-1"></div>
          <button type="submit" class="btn-primary w-full">Create Game</button>
        </form>
      </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close-btn" onclick="toggleShareModal(false)">&times;</button>
        <h2>Share Game</h2>
        <div id="share-options">
          <p class="mb-1">Share this game link:</p>
          <input type="text" id="share-link-input" readonly>
          <button id="copy-share-link-btn" class="mt-1">Copy Link</button>
          <button id="web-share-api-btn" class="hidden">Share via...</button>
        </div>
      </div>
    </div>

  </div> <!-- End #app-container -->

  <script>
    // --- SUPABASE CLIENT SETUP ---
    const SUPABASE_URL = 'https://aghnqhwhpiwndronbgkd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnaG5xaHdocGl3bmRyb25iZ2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5MDM4NTMsImV4cCI6MjA1OTQ3OTg1M30.jwYaXa_nb5HXQHjA3Bt6NUxYwQPDTawzNJvkOtI4Y1Q';
    let supabase = null;

    if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
      if (SUPABASE_URL && SUPABASE_ANON_KEY && SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
        try {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log("Supabase client initialized successfully.");
        } catch (error) {
          console.error("Error initializing Supabase client:", error);
          alert("DB connection error.");
          supabase = null;
        }
      } else {
        console.error("Supabase URL/Key not configured.");
        alert("App config error.");
      }
    } else {
      console.error("Supabase library failed to load!");
      alert("Critical Error: DB library missing.");
    }

    // --- APPLICATION STATE ---
    let currentUser = null;
    let userProfile = null;
    let currentScreen = 'loading';
    let currentGameId = null;
    let currentGameData = null;
    let gameSubscription = null;
    let gamesSubscription = null;
    let scoreProposals = {};
    let currentScoreProposal = null;
    let confirmingScore = false;
    let leaderboardScope = 'global';
    let leaderboardFilterValue = null;

    // --- UI ELEMENTS CACHE ---
    const screens = {
      loading: document.getElementById('loading-screen'),
      auth: document.getElementById('auth-screen'),
      main: document.getElementById('main-app-screen'),
      detail: document.getElementById('game-detail-screen'),
      active: document.getElementById('active-game-screen'),
      end: document.getElementById('game-end-screen'),
      profile: document.getElementById('profile-screen'),
      leaderboard: document.getElementById('leaderboard-screen'),
    };

    const authForm = document.getElementById('auth-form');
    const authTitle = document.getElementById('auth-title');
    const authSubmitBtn = document.getElementById('auth-submit-btn');
    const authToggleBtn = document.getElementById('auth-toggle-btn');
    const authToggleText = document.getElementById('auth-toggle-text');
    const usernameField = document.getElementById('username-field');
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const authError = document.getElementById('auth-error');
    const logoutBtn = document.getElementById('logout-btn');
    const gameList = document.getElementById('game-list');
    const gameListLoader = document.getElementById('game-list-loader');
    const noGamesMessage = document.getElementById('no-games-message');
    const createGameFab = document.getElementById('create-game-fab');
    const createGameModal = document.getElementById('create-game-modal');
    const createGameForm = document.getElementById('create-game-form');
    const createGameError = document.getElementById('create-game-error');
    const gameDetailLoader = document.getElementById('game-detail-loader');
    const gameDetailContent = document.getElementById('game-detail-content');
    const gameDetailLocation = document.getElementById('game-detail-location');
    const gameDetailDatetime = document.getElementById('game-detail-datetime');
    const gameDetailCreator = document.getElementById('game-detail-creator');
    const gameDetailStatus = document.getElementById('game-detail-status').querySelector('.status-indicator');
    const playerCount = document.getElementById('player-count');
    const maxPlayers = document.getElementById('max-players');
    const playerList = document.getElementById('player-list');
    const joinLeaveGameBtn = document.getElementById('join-leave-game-btn');
    const beginGameBtn = document.getElementById('begin-game-btn');
    const cancelGameBtn = document.getElementById('cancel-game-btn');
    const shareGameBtn = document.getElementById('share-game-btn');
    const gameDetailError = document.getElementById('game-detail-error');
    const activeGameLoader = document.getElementById('active-game-loader');
    const activeGameContent = document.getElementById('active-game-content');
    const teamAScore = document.getElementById('team-a-score');
    const teamBScore = document.getElementById('team-b-score');
    const teamAList = document.getElementById('team-a-list');
    const teamBList = document.getElementById('team-b-list');
    const scoreProposalMessage = document.getElementById('score-proposal-message');
    const scoreErrorMessage = document.getElementById('score-error-message');
    const scoreConfirmationModal = document.getElementById('score-confirmation-modal');
    const scoreConfirmText = document.getElementById('score-confirm-text');
    const confirmScoreBtn = document.getElementById('confirm-score-btn');
    const rejectScoreBtn = document.getElementById('reject-score-btn');
    const gameEndScreen = document.getElementById('game-end-screen');
    const gameEndTitle = document.getElementById('game-end-title');
    const finalScore = document.getElementById('final-score');
    const mvpUsername = document.getElementById('mvp-username');
    const mvpScore = document.getElementById('mvp-score');
    const mvpHighlight = document.getElementById('mvp-highlight');
    const confettiContainer = document.getElementById('confetti-container');
    const backToMainBtn = document.getElementById('back-to-main-btn');
    const viewLeaderboardBtn = document.getElementById('view-leaderboard-btn');
    const shareResultsBtn = document.getElementById('share-results-btn');
    const profileLoader = document.getElementById('profile-loader');
    const profileContent = document.getElementById('profile-content');
    const profileAvatar = document.getElementById('profile-avatar');
    const profileUsernameDisplay = document.getElementById('profile-username-display');
    const profileUsername = document.getElementById('profile-username');
    const profileEmail = document.getElementById('profile-email');
    const editProfileBtn = document.getElementById('edit-profile-btn');
    const saveProfileBtn = document.getElementById('save-profile-btn');
    const profileEditFields = document.getElementById('profile-edit-fields');
    const editProfileUsernameInput = document.getElementById('edit-profile-username-input');
    const editProfileCityInput = document.getElementById('edit-profile-city');
    const editProfileStateInput = document.getElementById('edit-profile-state');
    const editProfileCountryInput = document.getElementById('edit-profile-country');
    const profileUpdateMessage = document.getElementById('profile-update-message');
    const profileUpdateError = document.getElementById('profile-update-error');
    const profileStatPoints = document.getElementById('profile-stat-points');
    const profileStatGames = document.getElementById('profile-stat-games');
    const profileStatMvp = document.getElementById('profile-stat-mvp');
    const gameHistoryLoader = document.getElementById('game-history-loader');
    const gameHistoryList = document.getElementById('game-history-list');
    const noHistoryMessage = document.getElementById('no-history-message');
    const leaderboardLoader = document.getElementById('leaderboard-loader');
    const leaderboardListContainer = document.getElementById('leaderboard-list-container');
    const leaderboardList = document.getElementById('leaderboard-list');
    const noLeaderboardMessage = document.getElementById('no-leaderboard-message');
    const leaderboardFilters = document.getElementById('leaderboard-filters');
    const leaderboardStatus = document.getElementById('leaderboard-status');
    const profileNavBtn = document.getElementById('profile-nav-btn');
    const leaderboardNavBtn = document.getElementById('leaderboard-nav-btn');
    const backBtns = document.querySelectorAll('.back-btn');
    const chatDrawer = document.getElementById('chat-drawer');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendChatBtn = document.getElementById('send-chat-btn');
    const closeChatBtn = document.getElementById('close-chat-btn');
    const toggleChatBtn = document.getElementById('toggle-chat-btn');
    const activeGameToggleChatBtn = document.getElementById('active-game-toggle-chat-btn');
    const shareModal = document.getElementById('share-modal');
    const shareLinkInput = document.getElementById('share-link-input');
    const copyShareLinkBtn = document.getElementById('copy-share-link-btn');
    const webShareApiBtn = document.getElementById('web-share-api-btn');

    // --- UTILITY FUNCTIONS ---
    const debounce = (func, delay) => {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => { func.apply(this, args); }, delay);
      };
    };
    const formatDate = (dateString) => {
      if (!dateString) return 'Date TBD';
      try {
        const date = new Date(dateString);
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(now.getDate() + 1);
        const optionsTime = { hour: 'numeric', minute: 'numeric', hour12: true };
        const optionsDate = { month: 'short', day: 'numeric' };
        if (date.toDateString() === now.toDateString())
          return `Today, ${date.toLocaleTimeString('en-US', optionsTime)}`;
        else if (date.toDateString() === tomorrow.toDateString())
          return `Tomorrow, ${date.toLocaleTimeString('en-US', optionsTime)}`;
        else
          return `${date.toLocaleDateString('en-US', optionsDate)}, ${date.toLocaleTimeString('en-US', optionsTime)}`;
      } catch (e) {
        console.error("Date format error:", e);
        return "Invalid Date";
      }
    };
    const showElement = (el) => el?.classList.remove('hidden');
    const hideElement = (el) => el?.classList.add('hidden');
    const enableElement = (el) => { if(el) el.disabled = false; };
    const disableElement = (el) => { if(el) el.disabled = true; };

    const navigateTo = (screenName) => {
      if (!screens[screenName]) { console.error("Unknown screen:", screenName); return; }
      console.log(`Navigating to ${screenName}`);
      Object.values(screens).forEach(s => s.classList.remove('active'));
      screens[screenName].classList.add('active');
      currentScreen = screenName;
      if (screenName !== 'detail' && screenName !== 'active' && screenName !== 'end') {
        unsubscribeFromGame();
        currentGameId = null;
        currentGameData = null;
      }
      if (screenName !== 'main') {
        unsubscribeFromGamesList();
      }
      if (screenName !== 'detail' && screenName !== 'active') {
        toggleChatDrawer(false);
      }
    };

    const getUserAvatarText = (username) => username ? username.charAt(0).toUpperCase() : '?';

    const getUserProfile = async (userId) => {
      if (!supabase || !userId) return null;
      try {
        console.log("Fetching profile:", userId);
        const { data, error } = await supabase.from('profiles').select('*').eq('user_id', userId).single();
        if (error && error.code !== 'PGRST116') {
          console.error('Fetch profile error:', error);
          return null;
        }
        console.log("Profile fetched:", data);
        return data;
      } catch (error) {
        console.error('Fetch profile exception:', error);
        return null;
      }
    };

    const updateUserProfile = async (userId, updates) => {
      if (!supabase || !userId) return { error: { message: 'Client/ID missing' } };
      try {
        const { data, error } = await supabase.from('profiles').update(updates).eq('user_id', userId).select().single();
        return { data, error };
      } catch (error) {
        console.error('Update profile error:', error);
        return { error };
      }
    };

    const createInitialUserProfile = async (userId, email, username) => {
      if (!supabase) return { error: { message: 'Client missing' } };
      console.log(`Creating profile for ${userId}, user: ${username}`);
      try {
        const { data: existingUser, error: checkError } = await supabase.from('profiles').select('username').eq('username', username).maybeSingle();
        if (checkError && checkError.code !== 'PGRST116') {
          console.error('Username check error:', checkError);
        }
        if (existingUser) {
          console.warn(`Username ${username} taken.`);
          return { error: { message: 'Username taken.' } };
        }
        const { data, error } = await supabase.from('profiles').insert({ user_id: userId, email: email, username: username }).select().single();
        if (error) {
          console.error('Insert profile error:', error);
          return { error };
        }
        console.log(`Profile created ${userId}:`, data);
        return { data, error };
      } catch (error) {
        console.error('Create profile exception:', error);
        return { error };
      }
    };

    // --- SCREEN RENDERING FUNCTIONS ---
    // (Functions like renderGameList, renderGameDetail, renderActiveGame, etc. remain unchanged)
    // ...

    // --- DATA FETCHING AND UPDATING ---
    // (Functions like fetchGames, fetchGameDetails, createGame, joinGame, etc. remain unchanged)
    // ...

    // --- Collaborative Scoring Logic ---
    // (Scoring functions remain unchanged)
    // ...

    // --- REALTIME SUBSCRIPTIONS ---
    const subscribeToGamesList = () => {
      if (!supabase || gamesSubscription) return;
      console.log("Subscribing Games List...");
      gamesSubscription = supabase.channel('public:games-list').on('postgres_changes', { event: '*', schema: 'public', table: 'games' }, (p) => {
        console.log('List change!', p);
        if (currentScreen === 'main') fetchGames();
      }).subscribe((s, e) => {
        if(s==='SUBSCRIBED') console.log('List subscribed!');
        else if(s==='CHANNEL_ERROR'||s==='TIMED_OUT') console.error('List sub error:', s, e);
        else if(s==='CLOSED') console.log('List sub closed.');
      });
    };
    const unsubscribeFromGamesList = () => {
      if (gamesSubscription) {
        console.log("Unsub List.");
        supabase.removeChannel(gamesSubscription).catch(e => console.error("Remove list chan err:", e));
        gamesSubscription = null;
      }
    };
    const subscribeToGame = (gameId) => {
      if (!supabase || !gameId || gameSubscription) return;
      console.log(`Subscribing Game ${gameId}...`);
      const chan = `game-${gameId}`;
      gameSubscription = supabase.channel(chan).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'games', filter: `id=eq.${gameId}` }, (p) => {
        console.log(`Game ${gameId} update!`, p);
        const uG = p.new;
        const oG = p.old;
        currentGameData = uG;
        if (currentScreen === 'detail') {
          if (uG.status === 'pending') renderGameDetail(uG);
          else if (uG.status === 'active') {
            navigateTo('active');
            renderActiveGame(uG);
          } else if (uG.status === 'finished') {
            navigateTo('end');
            renderGameEnd(uG);
          } else if (uG.status === 'cancelled') {
            alert("Cancelled.");
            navigateTo('main');
            fetchGames();
          }
        } else if (currentScreen === 'active') {
          if (uG.status === 'active') {
            renderActiveGame(uG);
            checkAndApplyScore(uG);
          } else if (uG.status === 'finished') {
            navigateTo('end');
            renderGameEnd(uG);
          } else if (uG.status === 'cancelled') {
            alert("Cancelled.");
            navigateTo('main');
            fetchGames();
          }
        }
        if (JSON.stringify(uG.chat_log) !== JSON.stringify(oG?.chat_log) && (currentScreen === 'detail' || currentScreen === 'active')) {
          renderChatMessages(uG.chat_log || []);
        }
      }).subscribe((s, e) => {
        if (s === 'SUBSCRIBED') console.log(`Game ${gameId} subscribed!`);
        else if (s === 'CHANNEL_ERROR' || s === 'TIMED_OUT') {
          console.error(`Game ${gameId} sub error:`, s, e);
          if (currentScreen === 'detail' || currentScreen === 'active') alert("Realtime lost.");
        } else if (s === 'CLOSED') console.log(`Game ${gameId} sub closed.`);
      });
    };
    const unsubscribeFromGame = () => {
      if (gameSubscription) {
        const cN = gameSubscription.channelName;
        console.log(`Unsub ${cN}.`);
        supabase.removeChannel(gameSubscription).catch(e => console.error(`Remove ${cN} err:`, e));
        gameSubscription = null;
      }
    };

    // --- AUTHENTICATION LOGIC ---
    let isCheckingSession = false;
    const checkUserSession = async () => {
      if (isCheckingSession) return;
      isCheckingSession = true;
      try {
        console.log("Checking session...");
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) {
          console.error("Get session error:", error);
          navigateTo('auth');
        } else if (session?.user) {
          currentUser = session.user;
          console.log("Session found:", currentUser.id);
          if (!userProfile || userProfile.user_id !== currentUser.id)
            userProfile = await getUserProfile(currentUser.id);
          if (!userProfile) {
            console.warn("Profile missing:", currentUser.id);
            alert("Profile data missing.");
            if (currentScreen === 'auth' || currentScreen === 'loading') {
              navigateTo('main');
              fetchGames();
            }
          } else {
            console.log("Profile loaded:", userProfile.username);
            if (currentScreen === 'auth' || currentScreen === 'loading') {
              navigateTo('main');
              fetchGames();
            }
          }
        } else {
          console.log("No active session.");
          if (currentScreen !== 'auth') navigateTo('auth');
        }
      } catch (err) {
        console.error("Session check error:", err);
        if (currentScreen !== 'auth') navigateTo('auth');
      } finally {
        hideElement(screens.loading);
        isCheckingSession = false;
      }
    };

    const handleAuth = async (event) => {
      event.preventDefault();
      if (!supabase) return;
      const isSignUp = authSubmitBtn.textContent === 'Sign Up';
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const uname = usernameInput.value.trim();
      authError.textContent = '';
      disableElement(authSubmitBtn);
      let opError = null;
      try {
        if (isSignUp) {
          if (!uname || uname.length < 3) throw new Error("Username >= 3 chars.");
          const { data: sData, error: sError } = await supabase.auth.signUp({ email, password });
          if (sError) throw sError;
          if (!sData.user) throw new Error("Signup ok, no user data.");
          console.log("Signup ok:", sData.user.id);
          const { data: pData, error: pError } = await createInitialUserProfile(sData.user.id, email, uname);
          if (pError) throw new Error(`Account created, profile fail: ${pError.message}. Check email & login.`);
          userProfile = pData;
          currentUser = sData.user;
          alert("Signup ok! Check email verification.");
          authForm.reset();
        } else {
          const { data: siData, error: siError } = await supabase.auth.signInWithPassword({ email, password });
          if (siError) {
            if (siError.message.includes("Email not confirmed"))
              opError = new Error("Confirm email first.");
            else throw siError;
          } else if (siData.user) {
            currentUser = siData.user;
            await checkUserSession();
          } else {
            throw new Error("Login fail: No user data.");
          }
        }
      } catch (e) {
        console.error('Auth error:', e);
        opError = e;
      } finally {
        if (opError) authError.textContent = opError.message || 'Error.';
        if (!opError || !opError.message.includes("Confirm email"))
          enableElement(authSubmitBtn);
      }
    };

    const handleLogout = async () => {
      if (!supabase) return;
      console.log("Logging out...");
      unsubscribeFromGame();
      unsubscribeFromGamesList();
      currentGameId = null;
      currentGameData = null;
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error("Logout error:", error);
        alert("Logout error.");
      } else {
        currentUser = null;
        userProfile = null;
        leaderboardScope = 'global';
        navigateTo('auth');
        authTitle.textContent = 'Login';
        authSubmitBtn.textContent = 'Login';
        authToggleText.textContent = "No account?";
        authToggleBtn.textContent = 'Sign Up';
        hideElement(usernameField);
        authForm.reset();
        authError.textContent = '';
        console.log("Logged out.");
      }
    };

    const toggleAuthMode = () => {
      const isSignUp = authSubmitBtn.textContent === 'Sign Up';
      if (isSignUp) {
        authTitle.textContent = 'Login';
        authSubmitBtn.textContent = 'Login';
        authToggleText.textContent = "No account?";
        authToggleBtn.textContent = 'Sign Up';
        hideElement(usernameField);
      } else {
        authTitle.textContent = 'Sign Up';
        authSubmitBtn.textContent = 'Sign Up';
        authToggleText.textContent = 'Have account?';
        authToggleBtn.textContent = 'Login';
        showElement(usernameField);
      }
      authError.textContent = '';
      authForm.reset();
      enableElement(authSubmitBtn);
    };

    // Updated onAuthStateChange listener to prevent recursion
    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('Auth Event:', event, session ? 'Session User:' : 'No Session', session?.user?.id);
      if (event === 'SIGNED_OUT') {
        handleLogout();
      } else if (event === 'SIGNED_IN' || event === 'USER_UPDATED') {
        currentUser = session?.user ?? null;
        await checkUserSession();
      }
    });

    // --- UI EVENT HANDLERS, TOGGLES, AND INITIALIZATION ---
    // (Remaining event handlers and initialization functions remain unchanged)
    // ...

    function initApp() {
      console.log("Initializing HoopsLink App...");
      if (!supabase) {
        console.error("Supabase client needed.");
        hideElement(screens.loading);
        authError.textContent = "Config error.";
        authTitle.textContent = "Error";
        disableElement(authSubmitBtn);
        disableElement(authToggleBtn);
        navigateTo('auth');
        return;
      }

      authForm.addEventListener('submit', handleAuth);
      authToggleBtn.addEventListener('click', toggleAuthMode);
      logoutBtn.addEventListener('click', handleLogout);
      createGameFab.addEventListener('click', () => toggleCreateGameModal(true));
      createGameForm.addEventListener('submit', handleCreateGameSubmit);
      joinLeaveGameBtn.addEventListener('click', handleJoinLeaveClick);
      beginGameBtn.addEventListener('click', handleBeginGameClick);
      cancelGameBtn.addEventListener('click', handleCancelGameClick);
      shareGameBtn.addEventListener('click', () => {
        if (currentGameData) {
          const t = `Join "${currentGameData.location_name || 'Game'}"!`;
          showShareModal(t, window.location.href);
        }
      });
      activeGameContent.addEventListener('click', handleScoreClick);
      confirmScoreBtn.addEventListener('click', confirmScoreProposal);
      rejectScoreBtn.addEventListener('click', rejectScoreProposal);
      profileNavBtn.addEventListener('click', () => {
        if (currentUser) {
          navigateTo('profile');
          fetchProfileData(currentUser.id);
        } else {
          navigateTo('auth');
        }
      });
      leaderboardNavBtn.addEventListener('click', () => {
        navigateTo('leaderboard');
        fetchLeaderboard('global');
      });
      editProfileBtn.addEventListener('click', () => toggleProfileEdit(true));
      saveProfileBtn.addEventListener('click', handleProfileUpdate);
      leaderboardFilters.addEventListener('click', handleLeaderboardFilterClick);
      backBtns.forEach(b => b.addEventListener('click', () => {
        navigateTo('main');
        fetchGames();
      }));
      toggleChatBtn.addEventListener('click', () => toggleChatDrawer(true));
      activeGameToggleChatBtn.addEventListener('click', () => toggleChatDrawer(true));
      closeChatBtn.addEventListener('click', () => toggleChatDrawer(false));
      sendChatBtn.addEventListener('click', handleSendChat);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSendChat(e);
        }
      });
      copyShareLinkBtn.addEventListener('click', copyShareLink);

      checkUserSession();
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
